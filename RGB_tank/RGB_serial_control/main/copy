/*
 * RGB_fishtank.c
 *
 * Created: 17/01/2019 19:36:56
 * Author : GATIS
 */

#include <avr/io.h>
#define F_CPU 16000000UL
#include <util/delay.h>
#include "WS2811.h"
#define BIT(B)           (0x01 << (uint8_t)(B))
#define SET_BIT_HI(V, B) (V) |= (uint8_t)BIT(B)
#define SET_BIT_LO(V, B) (V) &= (uint8_t)~BIT(B)

#define PAUSE  1000     // msec
#define DELAY    10	// msec


// Define the output function, using pin 0 on port b. -> pin D8 arduino
DEFINE_WS2811_FN(WS2811RGB, PORTB, 0)

// Drive the three pixels in an infinit loop.

void threepixeldemo(void)
{
  for(;;){
    recvWithEndMarker();
    showNewData();
  }
    // Configure pin for output.
    // SET_BIT_HI(DDRB, 0);
    // SET_BIT_LO(PORTB, 0);
    //
    // // off->red, off->green, off->blue
    // RGB_t rgb[3] = {{0,0,0},{0,0,0},{0,0,0}};
    // WS2811RGB(rgb, ARRAYLEN(rgb));
    // _delay_ms(PAUSE);
    // // for(;;){
    //   for (int i = 0; i < 255; i++) {
    //     rgb[0].r += 1;
    //     rgb[1].g += 1;
    //     rgb[2].b += 1;
    //     WS2811RGB(rgb, ARRAYLEN(rgb));
    //     _delay_ms(DELAY);
    //   }
    // }
}
/////////////////////////////////////////////////////////////////
///////////////////////////////////////////////// Serial Coms //

const byte numChars = 32;
char receivedChars[numChars]; // an array to store the received data

boolean newData = false;

void recvWithEndMarker() {
 static byte ndx = 0;
 char endMarker = '\n';
 char rc;
 if(Serial.available())Serial.println(newData);
 
 while (Serial.available() > 0 && newData == false) {
 Serial.println("it's running");
 rc = Serial.read();

 if (rc != endMarker) {
   Serial.println("1");
   receivedChars[ndx] = rc;
   ndx++;
   if (ndx >= numChars) {
     ndx = numChars - 1;
   }
 }
 else {
   Serial.println("2");
   receivedChars[ndx] = '\0'; // terminate the string
   ndx = 0;
   newData = true;
 }
 }
}


void showNewData() {
 if (newData == true) {
 Serial.print("This just in ... ");
 Serial.println(receivedChars);
 newData = false;
 }
}

/////////////////////////////////////////////////////////////////

int main(void)
{
  Serial.begin(9600);
  Serial.println("<Arduino is ready>");
	threepixeldemo();
}
